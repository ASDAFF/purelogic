(function(){"use strict";BX.namespace("BX.Main.ui");BX.namespace("BX.Main.ui.block");BX.Main.ui.select=function(t,e){this.params=null;this.node=null;this.items=null;this.value=null;this.tabindex=null;this.searchButton=null;this.clearButton=null;this.removeButton=null;this.classSearchButton=null;this.classClearButton="";this.classSquareRemove="main-ui-square-delete";this.classSquareText="main-ui-square-item";this.classSquareIcon="main-ui-item-icon";this.classPopup="main-ui-select-inner";this.classShow="main-ui-popup-fast-show-animation";this.classClose="main-ui-popup-fast-close-animation";this.classInput="main-ui-square-search-item";this.classMenuItem="main-ui-select-inner-item";this.classMenuItemText="main-ui-select-inner-item-element";this.classMenuMultiItemText="main-ui-select-inner-label";this.classMenuItemChecked="main-ui-checked";this.classSquare="main-ui-square";this.classSquareContainer="main-ui-square-container";this.classTextValueNode="main-ui-select-name";this.classPopupItemInput="main-ui-select-inner-input";this.classPopupItemLabel="main-ui-select-inner-label";this.classMultiSelect="main-ui-multi-select";this.classSelect="main-ui-select";this.classDelete="main-ui-delete";this.classValueDelete="main-ui-control-value-delete";this.classValueDeleteItem="main-ui-control-value-delete-item";this.classSquareSelected="main-ui-square-selected";this.popup=null;this.popupItems=null;this.isShown=false;this.isMulti=false;this.input=null;this.init(t,e)};BX.Main.ui.select.prototype={init:function(t,e){var t,i,s,a;if(BX.type.isDomNode(t)){this.node=t}try{e=e||JSON.parse(BX.data(t,"params"))}catch(n){}if(BX.type.isPlainObject(e)){this.params=e;this.classSearchButton=this.prepareParam("classSearchButton");this.classClearButton=this.prepareParam("classClearButton");this.classSquareRemove=this.prepareParam("classSquareRemove");this.isMulti=this.prepareParam("isMulti")}i=this.getPopup();s=this.getInput();a=i.popupContainer;t=this.getNode();BX.bind(s,"blur",BX.delegate(this._onBlur,this));BX.bind(s,"focus",BX.delegate(this._onFocus,this));BX.bind(s,"keydown",BX.delegate(this._onKeyDown,this));BX.bind(a,"click",BX.delegate(this._onPopupClick,this));BX.bind(t,"click",BX.delegate(this._onControlClick,this))},_onKeyDown:function(t){var e=t.target;var i,s;if(this.isMulti){if(BX.hasClass(e,this.classInput)){i=this.getLastSquare();if(e.value.length===0&&t.code==="Backspace"){if(BX.type.isDomNode(i)){if(this.isSelected(i)){s=JSON.parse(BX.data(i,"item"));this.unselectItem(s)}else{this.selectSquare(i)}}}else{this.unselectSquare(i)}}}},isSelected:function(t){return BX.hasClass(t,this.classSquareSelected)},selectSquare:function(t){BX.addClass(t,this.classSquareSelected)},unselectSquare:function(t){BX.removeClass(t,this.classSquareSelected)},getLastSquare:function(){var t=this.getSquares();var e;if(BX.type.isArray(t)&&t.length){e=t[t.length-1]}return e},_onMenuItemClick:function(t){var e=t.target;var i,s;if(!BX.hasClass(e,this.classMenuItem)){e=BX.findParent(e,{"class":this.classMenuItem})}try{i=JSON.parse(BX.data(e,"item"))}catch(a){}if(this.isMulti){s=this.getSquare(i);if(!BX.type.isDomNode(s)){this.selectItem(i)}else{this.unselectItem(i)}this.adjustPopupPosition();this.inputFocus()}else{this.updateDataValue(i);this.updateValue(i);this.closePopup();this.inputBlur()}BX.onCustomEvent(window,"UI::Select::change",[this,i])},selectItem:function(t){var e=this.getPopupItem(t);this.addSquare(t);if(BX.type.isDomNode(e)){this.checkItem(e)}this.addMultiValue(t)},unselectItem:function(t){var e=this.getSquare(t);var i=this.getPopupItem(t);this.removeSquare(e);this.uncheckItem(i);this.removeMultiValue(t)},addMultiValue:function(t){var e=this.getDataValue();if(BX.type.isArray(e)){e.push(t);this.updateDataValue(e)}},removeMultiValue:function(t){var e=this.getDataValue();if(BX.type.isArray(e)&&e.length){e=e.filter(function(e){return e.VALUE!==t.VALUE&&e.NAME!==t.NAME},this);this.updateDataValue(e)}},getPopupItems:function(){var t=this.getPopup().popupContainer;if(!BX.type.isArray(this.popupItems)){this.popupItems=BX.findChild(t,{"class":this.classMenuItem},true,true)}return this.popupItems},getPopupItem:function(t){var e=this.getPopupItems();var i;var s=(e||[]).filter(function(e){i=JSON.parse(BX.data(e,"item"));return t.VALUE===i.VALUE&&t.NAME===i.NAME});return BX.type.isArray(s)&&s.length>0?s[0]:null},checkItem:function(t){if(!BX.hasClass(t,this.classMenuItemChecked)){BX.addClass(t,this.classMenuItemChecked)}},uncheckItem:function(t){if(BX.hasClass(t,this.classMenuItemChecked)){BX.removeClass(t,this.classMenuItemChecked)}},updateDataValue:function(t){var e=this.getNode();var i=JSON.stringify(t);e.dataset.value=i},getDataValue:function(){var t=this.getNode();var e;try{e=JSON.parse(BX.data(t,"value"))}catch(i){}if(!BX.type.isPlainObject(e)&&!BX.type.isArray(e)){e=this.isMulti?[]:{}}return e},getTextValueNode:function(){var t=this.getNode();var e=BX.findChild(t,{"class":this.classTextValueNode},true,false);return e},updateValue:function(t){var e=this.getTextValueNode();BX.html(e,t.NAME)},adjustPopupPosition:function(){var t=this.getPopup();var e=BX.pos(this.getNode());e.forceBindPosition=true;t.adjustPosition(e)},_onControlClick:function(t){var e,i,s;var a=t.target;if(!this.getPopup().isShown()||this.isMulti){this.inputFocus()}else{this.inputBlur()}if(!BX.hasClass(a,this.classValueDelete)&&!BX.hasClass(a,this.classValueDeleteItem)){if(BX.hasClass(a,this.classSquareRemove)){i=a.parentNode;e=JSON.parse(BX.data(i,"item"));this.unselectItem(e)}}else{s=this.getSquares();(s||[]).forEach(function(t){e=JSON.parse(BX.data(t,"item"));this.unselectItem(e)},this);this.getInput().value="";return false}},inputBlur:function(){var t=this.getInput();if(BX.type.isDomNode(t)){this.getInput().blur()}else{this._onBlur()}},inputFocus:function(){var t=this.getInput();if(BX.type.isDomNode(t)){if(document.activeElement!==t){t.focus()}}},_onPopupClick:function(t){this.inputFocus()},_onFocus:function(){var t=this.getPopup();clearTimeout(this.blurTimer);if(!t.isShown()){this.showPopup()}},_onBlur:function(t){var e=this;this.blurTimer=setTimeout(function(){e.closePopup()},50)},getInput:function(){if(!BX.type.isDomNode(this.input)){this.input=BX.findChild(this.getNode(),{"class":this.classInput},true,false)}return this.input},getSquares:function(){return BX.findChild(this.getSquareContainer(),{"class":this.classSquare},true,true)},getSquare:function(t){var e=this.getSquares();var i,s;if(!BX.type.isPlainObject(t)){try{t=JSON.parse(t)}catch(a){}}i=(e||[]).filter(function(e){try{s=JSON.parse(BX.data(e,"item"))}catch(i){s={}}return s.VALUE===t.VALUE&&s.NAME===t.NAME});return i.length?i[0]:null},removeSquare:function(t){var e;if(BX.type.isDomNode(t)){e=t}else{e=this.getSquare(data)}BX.remove(e);this.adjustPopupPosition()},createItem:function(t){var e,i;i=BX.create("div",{props:{className:this.classMenuItem},attrs:{"data-item":JSON.stringify(t)}});if(!this.isMulti){e=BX.create("div",{props:{className:this.classMenuItemText},text:t.NAME})}else{e=BX.create("div",{props:{className:this.classMenuMultiItemText},text:t.NAME})}BX.append(e,i);return i},createSquare:function(t){if(!BX.type.isPlainObject(t)){try{t=JSON.parse(t)}catch(e){}}var i=BX.create("span",{props:{className:this.classSquare}});i.dataset.item=JSON.stringify(t);var s=BX.create("span",{props:{className:this.classSquareText},text:t.NAME});var a=BX.create("span",{props:{className:[this.classSquareIcon,this.classSquareRemove].join(" ")}});BX.append(s,i);BX.append(a,i);return i},getSquareContainer:function(){if(!BX.type.isDomNode(this.squareContainer)){this.squareContainer=BX.findChild(this.getNode(),{"class":this.classSquareContainer},true,false)}return this.squareContainer},addSquare:function(t){var e=this.getSquareContainer();var i=this.createSquare(t);BX.append(i,e)},closePopup:function(){var t=this.getPopup();var e=t.popupContainer;var i=0;var s=this;BX.removeClass(e,this.classShow);BX.addClass(e,this.classClose);i=parseFloat(BX.style(e,"animation-duration"));if(BX.type.isNumber(i)){i=i*1e3}setTimeout(function(){t.close();s.inputBlur()},i)},getNode:function(){return this.node},showPopup:function(){var t=this;var e=this.getPopup();var i=this.getInput();var s=e.popupContainer;if(!e.isShown()){this.adjustPopupPosition();e.show();BX.removeClass(s,this.classClose);BX.addClass(s,t.classShow)}},getItems:function(){var t=BX.data(this.getNode(),"items");if(!BX.type.isArray(this.items)){if(!BX.type.isArray(t)){this.items=JSON.parse(t)}else{this.items=t}}return this.items},getPopup:function(){if(!this.popup){this.popup=this.createPopup(this.getItems())}return this.popup},createPopupItems:function(t){var e=BX.create("div");var i;t.forEach(function(t){i=this.createItem(t);BX.append(i,e);BX.bind(i,"click",BX.delegate(this._onMenuItemClick,this))},this);return e},createPopup:function(t){var e,i,s;if(BX.type.isArray(t)&&!this.popup){i=BX.pos(this.getNode());this.popup=new BX.PopupWindow("main-filter-control-popup",this.getNode(),{autoHide:false,offsetTop:2,offsetLeft:0,lightShadow:true,closeIcon:false,closeByEsc:false,noAllPaddings:true,zIndex:2e3});BX.style(this.popup.popupContainer,"min-width",i.width+"px");BX.addClass(this.popup.popupContainer,this.classPopup);s=this.createPopupItems(t);this.popup.setContent(s)}return this.popup},prepareParam:function(t){return t in this.params?this.params[t]:this[t]},getParams:function(){return this.params}};BX.Main.ui.block["main-ui-square"]=function(t){return{block:"main-ui-square",attrs:{"data-item":"item"in t?JSON.stringify(t.item):""},content:[{block:"main-ui-square-item",content:"name"in t?t.name:""},{block:"main-ui-square-delete",mix:["main-ui-item-icon"]}]}};BX.Main.ui.block["main-ui-multi-select"]=function(t){var e,i,s,a,n;var u=[];if("value"in t&&BX.type.isArray(t.value)){u=t.value.map(function(t){return{block:"main-ui-square",name:"NAME"in t?t.NAME:"",item:t}},this)}e={block:"main-ui-multi-select",mix:["main-ui-control"],attrs:{"data-name":t.name,"data-params":JSON.stringify(t.params),"data-items":JSON.stringify(t.items),"data-value":JSON.stringify(t.value)},content:[]};s={block:"main-ui-square-container",tag:"span",content:u};n={block:"main-ui-square-search",tag:"span",content:{block:"main-ui-square-search-item",tag:"input",attrs:{type:"text",tabindex:"tabindex"in t?t.tabindex:"",placeholder:"placeholder"in t?t.placeholder:""}}};e.content.push(s);e.content.push(n);if("valueDelete"in t&&t.valueDelete===true){a={block:"main-ui-control-value-delete",tag:"span",content:{block:"main-ui-control-value-delete-item"}};e.content.push(a)}return e};BX.Main.ui.block["main-ui-select"]=function(t){var e,i,s,a;e={block:"main-ui-select",mix:["main-ui-control"],attrs:{"data-name":t.name,"data-params":JSON.stringify(t.params),"data-items":JSON.stringify(t.items),"data-value":JSON.stringify(t.value)},content:[]};i={block:"main-ui-select-name",tag:"span",content:"value"in t&&BX.type.isPlainObject(t.value)?t.value.NAME:""};s={block:"main-ui-square-search",tag:"span",content:{block:"main-ui-square-search-item",tag:"input",attrs:{type:"text",tabindex:t.tabindex}}};if("valueDelete"in t&&t.valueDelete===true){a={block:"main-ui-control-value-delete",content:{block:"main-ui-control-value-delete-item",tag:"span"}}}e.content.push(i);e.content.push(s);if(BX.type.isPlainObject(a)){e.content.push(a)}return e}})();
//# sourceMappingURL=core_ui_select.map.js